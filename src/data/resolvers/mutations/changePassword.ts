import { User, IUser, IViewer } from "../../models";
import { MailService, Email } from "../../../smtp";

export interface IChangePasswordArg {
  oldPassword: string;
  newPassword: string;
}

export const changePassword: (root: IViewer, arg: IChangePasswordArg) => Promise<IUser> = (viewer, user) => {
  return User.findOneByToken(viewer.token)
    .then((existingUser: IUser) => {
      if (!existingUser || user.oldPassword !== existingUser.password) {
        console.log(`No user found for token or password not correct: ${viewer.token}`);
        throw Error("No user found for token or password not correct");
      }

      existingUser.password = user.newPassword;
      existingUser.autoGenerated = false;
      existingUser.token = null;

      return User.save(existingUser)
        .then(newUser => {
          console.log(`Password changed for ${newUser.email} to '${newUser.password}'`);

          const ms = new MailService();
          return ms.sendMail(new Email(
            existingUser.email,
            "Password changed for Racket O Meter",
            `Your password has been changed.`,
            `<b>Your password has been changed.<b>`
          )).then(() => existingUser);
        });
    });
};
