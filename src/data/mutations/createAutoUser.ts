import { User, IUser } from "../connectors";
import { MailService, Email } from "../../smtp";

export interface IAutoUserArgument {
  user: IUser;
}

export const createAutoUser = (root, { user }: IAutoUserArgument) => {
  return User.findOne({ email: user.email })
    .then((existingUser: IUser) => {
      if (existingUser) {
        console.log("CreateAutoUser: Email in use");
        throw Error("Email in use");
      }

      user.isConsultant = false;
      user.isCoach = false;

      console.warn("CreateAutoUser: Set default password: '1234'");
      user.password = "1234";

      let ms = new MailService();
      ms.sendMail(new Email(
        user.email,
        "email testing!",
        `Your autogenerated password is: ${user.password}`,
        `<b>Your autogenerated password is:${user.password}<b>`
      ));

      return User.create(user)
        .catch((err) => {
          console.log("CreateAutoUser: Error creating user", err);
        });
    });
};
